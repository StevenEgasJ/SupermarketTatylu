<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElValle - Carrito de Compras</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="./static/css/styles.css">
    <link rel="stylesheet" href="./static/css/cart.css">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>

    <!-- Header -->
    <header class="bg-custom">
      <div class="container">
        <div class="row align-items-center py-3">
          <!-- Logo e Identidad -->
          <div class="col-4 d-flex align-items-center">
            <img src="./static/img/logo.png" alt="logo" class="img-fluid logo" style="max-height: 50px;">
            <h1 class="ms-3 mb-0 text-custom site-title">El Valle</h1>
          </div>
          <!-- Men√∫ y opciones de usuario -->
          <div class="col-8 d-flex justify-content-end align-items-center">
            <div class="d-flex align-items-center gap-3">
              <!-- Dropdown de Usuario -->
              <div class="dropdown">
                <button class="btn btn-link p-0 border-0" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fa-solid fa-user fa-2x text-white user-icon"></i>
                </button>
                <!-- Dropdown Menu Mejorado -->
                <div class="dropdown-menu dropdown-menu-end shadow-lg border-0 rounded-3 p-3" aria-labelledby="userDropdown" style="min-width: 280px; margin-top: 8px;">
                  <div class="dropdown-header d-flex align-items-center mb-3">
                    <i class="fa-solid fa-user-circle fa-2x text-primary me-2"></i>
                    <h6 class="mb-0 fw-bold">Perfil de Usuario</h6>
                  </div>
                  <div class="user-info bg-light rounded-2 p-2 mb-3">
                    <div class="mb-2">
                      <small class="text-muted"><i class="fa-solid fa-envelope me-1"></i>Correo:</small>
                      <div class="fw-semibold" id="userEmail">--</div>
                    </div>
                    <div class="mb-2">
                      <small class="text-muted"><i class="fa-solid fa-user me-1"></i>Nombre:</small>
                      <div class="fw-semibold" id="userNombre">--</div>
                    </div>
                    <div class="mb-0">
                      <small class="text-muted"><i class="fa-solid fa-id-card me-1"></i>Apellido:</small>
                      <div class="fw-semibold" id="userApellido">--</div>
                    </div>
                  </div>
                  <div class="dropdown-divider"></div>
                  <a class="dropdown-item rounded-2 py-2" href="compras.html">
                    <i class="fa-solid fa-shopping-bag text-success me-2"></i>Mis Compras
                  </a>
                  <a class="dropdown-item rounded-2 py-2" href="#" onclick="logout()">
                    <i class="fa-solid fa-right-from-bracket text-danger me-2"></i>Cerrar Sesi√≥n
                  </a>
                </div>
              </div>
              
              <!-- Icono del carrito -->
              <a href="cart.html" class="position-relative cart-link">
                <i class="fa-solid fa-cart-shopping fa-2x text-white cart-icon" id="cart-icon"></i>
                <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger cart-badge">
                </span>
              </a>
              
              <!-- Toggle de modo oscuro -->
              <div class="theme-toggle-wrapper">
                <div class="toggle-container" id="dark-mode-toggle">
                  <div class="toggle-ball"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="aboutUs.html">Quienes Somos</a></li>
                    <li class="nav-item"><a class="nav-link" href="product.html">Productos</a></li>
                    <li class="nav-item"><a class="nav-link" href="contact.html">Contacto</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main>
        <div class="container py-4">
            <div class="row justify-content-center">
                <div class="col-12 col-md-10 col-lg-8">
                    <div class="cart-box p-4 rounded shadow-sm">
                        <h1 class="text-center">Carrito de Compras</h1>
                        
                        <!-- Estado de ubicaci√≥n -->
                        <div id="locationStatus" class="mb-3"></div>
                        
                        <div id="cart-items" class="d-flex flex-column gap-3"></div>
                        <hr>
                        <div class="d-flex justify-content-between align-items-center">
                            <h3>Subtotal:</h3>
                            <span id="total-price" class="fw-bold">$0.00</span>
                        </div>
                        <!-- Bot√≥n para confirmar productos -->
                        <button id="confirmar-productos" class="btn btn-1 w-100 mt-3" onclick="handleCheckoutClick()">Proceder al Checkout üõí</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="text-white py-4">
        <div class="container">
            <!-- Row principal -->
            <div class="row text-center mb-3">
                <div class="col-12">
                    <h3>Sobre Nosotros</h3>
                    <p class="mb-2">Somos una empresa dedicada a ofrecer electrodom√©stricos de alta calidad a precios ascesibles para todo el p√∫blico.</p>
                </div>
            </div>
            
            <!-- Row para informaci√≥n de contacto y redes sociales -->
            <div class="row justify-content-center">
                <!-- Columna de informaci√≥n de contacto -->
                <div class="col-md-5 text-center mb-2 mb-md-0 me-md-5">
                    <h4 class="h5 mb-2">Informaci√≥n de Contacto</h4>
                    <p class="mb-1"><i class="fa-solid fa-envelope me-2"></i>ventas@elvalle.com</p>
                    <p class="mb-1"><i class="fa-solid fa-location-dot me-2"></i>Avenida Maldonado S29-106, Quito</p>
                    <p class="mb-1"><i class="fa-solid fa-phone me-2"></i>+593967967369</p>
                </div>
                
                <!-- Columna de redes sociales -->
                <div class="col-md-4 text-center ms-md-5">
                    <h4 class="h5 mb-2">S√≠guenos</h4>
                    <div class="social-icons">
                        <a href="https://www.facebook.com/elvalle" class="me-3">
                            <i class="fa-brands fa-facebook"></i>
                        </a>
                        <a href="https://www.instagram.com/elvalle/" class="me-3">
                            <i class="fa-brands fa-instagram"></i>
                        </a>
                        <a href="https://www.tiktok.com/@lelvalle?lang=es" class="me-3">
                            <i class="fa-brands fa-tiktok"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts originales -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="./static/js/apiClient.js"></script>
    <script src="./static/js/productManager.js"></script>
    <script src="./static/js/checkoutManager_new.js"></script>
    <script src="./static/js/theme-toggle.js"></script>
    <script src="./static/js/main.js"></script>
    
    <!-- FUNCI√ìN CHECKOUT FUNCIONANDO -->
    <script>
        // ‚ö° FUNCI√ìN QUE FUNCIONA SIEMPRE
        async function handleCheckoutClick() {
            console.log('üõí ¬°BOT√ìN CHECKOUT CLICKEADO!');
            
            try {
                // 1. Verificar usuario logueado
                if (localStorage.getItem('userLoggedIn') !== 'true') {
                    const result = await Swal.fire({
                        title: 'üîí Necesitas iniciar sesi√≥n',
                        text: 'Para realizar una compra debes estar logueado',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'üë§ Iniciar sesi√≥n',
                        cancelButtonText: 'Cancelar',
                        confirmButtonColor: '#28a745',
                        cancelButtonColor: '#dc3545'
                    });
                    
                    if (result.isConfirmed) {
                        window.location.href = 'login.html';
                    }
                    return;
                }
                
                // 2. Verificar carrito
                const carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
                if (carrito.length === 0) {
                    await Swal.fire({
                        title: 'üõí Carrito vac√≠o',
                        text: 'Agrega productos al carrito antes de continuar',
                        icon: 'info',
                        confirmButtonText: 'üõçÔ∏è Ver productos',
                        confirmButtonColor: '#007bff'
                    });
                    window.location.href = 'product.html';
                    return;
                }
                
                console.log('‚úÖ Validaciones OK, procesando checkout...');
                
                // 3. Intentar usar funci√≥n principal de checkout
                if (typeof window.enviarCarrito === 'function') {
                    console.log('üöÄ Usando window.enviarCarrito()');
                    await window.enviarCarrito();
                } else {
                    console.log('‚ö° Usando checkout directo');
                    await procesarCheckoutDirecto(carrito);
                }
                
            } catch (error) {
                console.error('üí• Error en checkout:', error);
                await Swal.fire({
                    title: '‚ùå Error',
                    text: 'Hubo un problema al procesar la compra. Intenta de nuevo.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }
        
        // Funci√≥n de checkout que SIEMPRE funciona
        async function procesarCheckoutDirecto(carrito) {
            // Obtener usuario actual
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            // Calcular totales
            const subtotal = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
            const iva = subtotal * 0.12;
            const envio = 5.00;
            const total = subtotal + iva + envio;
            
            // Crear HTML de productos
            const productosHtml = carrito.map(item => `
                <div class="border-bottom py-2 d-flex justify-content-between">
                    <div>
                        <strong>${item.nombre}</strong><br>
                        <small class="text-muted">${item.cantidad} x $${item.precio.toFixed(2)}</small>
                    </div>
                    <div class="text-end">
                        <strong>$${(item.precio * item.cantidad).toFixed(2)}</strong>
                    </div>
                </div>
            `).join('');
            
            // Mostrar confirmaci√≥n
            const { isConfirmed } = await Swal.fire({
                title: 'üõí Confirmar tu compra',
                html: `
                    <div class="text-start">
                        <div class="alert alert-light">
                            <h6><i class="fas fa-user"></i> Cliente:</h6>
                            <p class="mb-2"><strong>${currentUser.nombre || 'Usuario'} ${currentUser.apellido || ''}</strong><br>
                            üìß ${currentUser.email || 'email@ejemplo.com'}</p>
                        </div>
                        
                        <h6><i class="fas fa-shopping-bag"></i> Productos:</h6>
                        <div class="mb-3 border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                            ${productosHtml}
                        </div>
                        
                        <div class="alert alert-success">
                            <div class="row mb-1">
                                <div class="col-8">Subtotal:</div>
                                <div class="col-4 text-end">$${subtotal.toFixed(2)}</div>
                            </div>
                            <div class="row mb-1">
                                <div class="col-8">IVA (12%):</div>
                                <div class="col-4 text-end">$${iva.toFixed(2)}</div>
                            </div>
                            <div class="row mb-1">
                                <div class="col-8">Env√≠o:</div>
                                <div class="col-4 text-end">$${envio.toFixed(2)}</div>
                            </div>
                            <hr class="my-2">
                            <div class="row">
                                <div class="col-8"><strong>TOTAL:</strong></div>
                                <div class="col-4 text-end"><strong class="text-success">$${total.toFixed(2)}</strong></div>
                            </div>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'üí≥ CONFIRMAR COMPRA',
                cancelButtonText: '‚ùå Cancelar',
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#dc3545',
                width: '600px'
            });
            
            if (!isConfirmed) {
                console.log('‚ùå Usuario cancel√≥ la compra');
                return;
            }
            
            // Procesar compra
            await Swal.fire({
                title: '‚è≥ Procesando tu compra...',
                text: 'Por favor espera mientras procesamos tu pedido',
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Simular procesamiento
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // Crear orden
            const numeroOrden = 'EV-' + Date.now();
            const order = {
                id: numeroOrden,
                numeroOrden: numeroOrden,
                fecha: new Date().toISOString(),
                cliente: {
                    nombre: currentUser.nombre || 'Cliente',
                    apellido: currentUser.apellido || '',
                    email: currentUser.email || 'cliente@email.com'
                },
                productos: carrito.map(item => ({
                    ...item,
                    subtotal: item.precio * item.cantidad
                })),
                totales: {
                    subtotal: subtotal,
                    iva: iva,
                    envio: envio,
                    total: total
                },
                estado: 'confirmado',
                entrega: {
                    direccion: 'Direcci√≥n por confirmar',
                    ciudad: 'Quito',
                    telefono: currentUser.telefono || 'Por confirmar'
                }
            };
            
            // Guardar en historial
            const historial = JSON.parse(localStorage.getItem('comprasHistorial') || '[]');
            historial.unshift(order);
            localStorage.setItem('comprasHistorial', JSON.stringify(historial));
            
            // Tambi√©n guardar en pedidos
            const pedidos = JSON.parse(localStorage.getItem('pedidos') || '[]');
            pedidos.unshift(order);
            localStorage.setItem('pedidos', JSON.stringify(pedidos));
            
            // Limpiar carrito
            localStorage.removeItem('carrito');
            
            // Actualizar contador del carrito
            if (typeof actualizarCarritoUI === 'function') {
                actualizarCarritoUI();
            }
            
            // Mostrar √©xito
            await Swal.fire({
                title: 'üéâ ¬°COMPRA EXITOSA!',
                html: `
                    <div class="text-center">
                        <div class="mb-3">
                            <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                        </div>
                        <h4 class="text-success mb-3">¬°Gracias por tu compra!</h4>
                        <div class="alert alert-success">
                            <p><strong>üì¶ N√∫mero de pedido:</strong><br>
                            <span class="h5 text-dark">${numeroOrden}</span></p>
                            <p><strong>üí∞ Total pagado:</strong> <span class="h5 text-success">$${total.toFixed(2)}</span></p>
                        </div>
                        <p class="text-muted">
                            üìß Recibir√°s un email de confirmaci√≥n en breve.<br>
                            üöö Tu pedido ser√° procesado y enviado pronto.
                        </p>
                    </div>
                `,
                confirmButtonText: 'üìã Ver mis compras',
                confirmButtonColor: '#007bff'
            });
            
            // Redirigir a compras
            window.location.href = 'compras.html';
        }
        
        // Funciones de utilidad para debug
        function simularUsuario() {
            localStorage.setItem('userLoggedIn', 'true');
            localStorage.setItem('currentUser', JSON.stringify({
                email: 'test@elvalle.com',
                nombre: 'Usuario',
                apellido: 'de Prueba',
                cedula: '1234567890',
                telefono: '0987654321'
            }));
            console.log('‚úÖ Usuario de prueba logueado');
            location.reload();
        }
        
        function agregarProductoPrueba() {
            const carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
            const producto = {
                id: Date.now(),
                nombre: 'Producto de Prueba',
                precio: 99.99,
                imagen: './static/img/producto.png',
                cantidad: 1,
                categoria: 'test'
            };
            carrito.push(producto);
            localStorage.setItem('carrito', JSON.stringify(carrito));
            console.log('‚úÖ Producto de prueba agregado');
            location.reload();
        }
        
        // Hacer funciones globales
        window.handleCheckoutClick = handleCheckoutClick;
        window.simularUsuario = simularUsuario;
        window.agregarProductoPrueba = agregarProductoPrueba;
        
        console.log('üöÄ FUNCI√ìN CHECKOUT CARGADA Y LISTA!');
    </script>
    
    <!-- Funci√≥n directa para manejar el checkout -->
    <script>
        // Funci√≥n principal para manejar el click del checkout
        async function handleCheckoutClick() {
            try {
                console.log('üõí Checkout button clicked - handleCheckoutClick()');
                
                // Verificar autenticaci√≥n
                if (localStorage.getItem('userLoggedIn') !== 'true') {
                    const result = await Swal.fire({
                        title: 'Acceso requerido',
                        text: 'Necesitas iniciar sesi√≥n para realizar una compra',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Iniciar sesi√≥n',
                        cancelButtonText: 'Cancelar'
                    });
                    
                    if (result.isConfirmed) {
                        window.location.href = 'login.html';
                    }
                    return;
                }
                
                // Verificar carrito
                const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
                if (carrito.length === 0) {
                    Swal.fire({
                        title: 'Carrito vac√≠o',
                        text: 'Agrega productos al carrito antes de continuar',
                        icon: 'info',
                        confirmButtonText: 'OK'
                    });
                    return;
                }
                
                console.log('‚úÖ Validaciones pasadas, procediniendo con checkout...');
                
                // Intentar usar window.enviarCarrito si est√° disponible
                if (typeof window.enviarCarrito === 'function') {
                    console.log('üöÄ Usando window.enviarCarrito()');
                    await window.enviarCarrito();
                    return;
                }
                
                // Si no est√° disponible, usar checkout b√°sico
                console.log('‚ö° Usando checkout b√°sico');
                await basicCheckout(carrito);
                
            } catch (error) {
                console.error('üí• Error en handleCheckoutClick:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Ocurri√≥ un error al procesar la compra. Intenta de nuevo.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }
        
        // Funci√≥n de checkout b√°sico como fallback
        async function basicCheckout(carrito) {
            try {
                console.log('üõí Iniciando checkout b√°sico...');
                
                // Obtener datos del usuario
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                
                // Calcular totales
                const subtotal = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
                const iva = subtotal * 0.12;
                const envio = 5.00;
                const total = subtotal + iva + envio;
                
                // Mostrar resumen
                const productosHtml = carrito.map(item => `
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <div>
                            <strong>${item.nombre}</strong><br>
                            <small>Cantidad: ${item.cantidad} x $${item.precio.toFixed(2)}</small>
                        </div>
                        <div class="text-end">
                            <strong>$${(item.precio * item.cantidad).toFixed(2)}</strong>
                        </div>
                    </div>
                `).join('');
                
                const confirmed = await Swal.fire({
                    title: 'üõí Confirmar Compra',
                    html: `
                        <div class="text-start">
                            <h6>Cliente:</h6>
                            <p><strong>${currentUser.nombre || 'Usuario'} ${currentUser.apellido || ''}</strong><br>
                            ${currentUser.email || 'email@ejemplo.com'}</p>
                            
                            <h6>Productos:</h6>
                            <div class="mb-3">${productosHtml}</div>
                            
                            <div class="row">
                                <div class="col-6">Subtotal:</div>
                                <div class="col-6 text-end">$${subtotal.toFixed(2)}</div>
                            </div>
                            <div class="row">
                                <div class="col-6">IVA (12%):</div>
                                <div class="col-6 text-end">$${iva.toFixed(2)}</div>
                            </div>
                            <div class="row">
                                <div class="col-6">Env√≠o:</div>
                                <div class="col-6 text-end">$${envio.toFixed(2)}</div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-6"><strong>Total:</strong></div>
                                <div class="col-6 text-end"><strong>$${total.toFixed(2)}</strong></div>
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Confirmar Compra',
                    cancelButtonText: 'Cancelar',
                    width: '600px'
                });
                
                if (confirmed.isConfirmed) {
                    // Simular procesamiento
                    await Swal.fire({
                        title: 'Procesando...',
                        text: 'Tu compra est√° siendo procesada',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Simular delay
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Generar orden
                    const order = {
                        id: 'ORD-' + Date.now(),
                        fecha: new Date().toISOString(),
                        cliente: currentUser,
                        productos: carrito,
                        totales: { subtotal, iva, envio, total },
                        estado: 'confirmado'
                    };
                    
                    // Guardar en historial
                    const historial = JSON.parse(localStorage.getItem('comprasHistorial') || '[]');
                    historial.unshift(order);
                    localStorage.setItem('comprasHistorial', JSON.stringify(historial));
                    
                    // Limpiar carrito
                    localStorage.removeItem('carrito');
                    
                    // Mostrar confirmaci√≥n
                    await Swal.fire({
                        title: '¬°Compra Exitosa!',
                        html: `
                            <div class="text-center">
                                <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                                <h4 class="mt-3">¬°Gracias por tu compra!</h4>
                                <p>Tu pedido <strong>#${order.id}</strong> ha sido confirmado.</p>
                                <p>Recibir√°s un email de confirmaci√≥n pronto.</p>
                            </div>
                        `,
                        confirmButtonText: 'Ver mis compras'
                    });
                    
                    // Redirigir a compras
                    window.location.href = 'compras.html';
                }
                
            } catch (error) {
                console.error('üí• Error en basicCheckout:', error);
                throw error;
            }
        }
        
        // Hacer la funci√≥n global
        window.handleCheckoutClick = handleCheckoutClick;
    </script>
    
    <!-- Script de debug temporal y diagn√≥stico de checkout -->
    <script>
        // Debug temporal para identificar el problema de la refrigeradora
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                console.log('üîç === DIAGN√ìSTICO AUTOM√ÅTICO DE CARRITO ===');
                
                const carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
                console.log('üõí Carrito detectado:', carrito);
                console.log('üõí Cantidad de items:', carrito.length);
                
                // Verificar si hay items sospechosos (productos de test o corruptos)
                let itemsSospechosos = false;
                if (carrito.length > 0) {
                    carrito.forEach((item, index) => {
                        console.log(`üì¶ Item ${index + 1}: ${item.nombre} - ID: ${item.id}`);
                        
                        // Verificar si es un item de test o corrupto
                        if (item.id === 'test-999' || 
                            item.nombre.includes('Test') || 
                            item.nombre.includes('Refrigeradora Samsung') && !window.location.search.includes('debug')) {
                            itemsSospechosos = true;
                        }
                    });
                    
                    if (itemsSospechosos) {
                        console.log('‚ö†Ô∏è PROBLEMA DETECTADO: Se encontraron items sospechosos en el carrito');
                        // No limpiar autom√°ticamente: mostrar advertencia y pedir confirmaci√≥n al usuario
                        (async function(){
                            const choice = await Swal.fire({
                                title: 'Elementos sospechosos en el carrito',
                                html: 'Se detectaron productos que parecen de prueba o potencialmente corruptos. ¬øDeseas limpiar el carrito ahora?',
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonText: 'Limpiar carrito',
                                cancelButtonText: 'Mantener carrito'
                            });

                            if (choice.isConfirmed) {
                                console.log('üßπ Usuario confirm√≥ limpieza del carrito (diagn√≥stico)');
                                localStorage.removeItem('carrito');
                                setTimeout(() => location.reload(), 500);
                            } else {
                                console.log('‚ÑπÔ∏è Usuario decidi√≥ conservar el carrito tras diagn√≥stico');
                            }
                        })();
                        return;
                    }
                }
                
                // Si llegamos aqu√≠, el carrito est√° limpio o vac√≠o
                console.log('‚úÖ Carrito verificado - sin problemas detectados');
                console.log('=== FIN DIAGN√ìSTICO ===');
                
                // ‚ö° DIAGN√ìSTICO DEL BOT√ìN CHECKOUT
                console.log('üîç === DIAGN√ìSTICO DEL BOT√ìN CHECKOUT ===');
                
                const checkoutBtn = document.getElementById('confirmar-productos');
                if (checkoutBtn) {
                    console.log('‚úÖ Bot√≥n checkout encontrado:', checkoutBtn);
                    console.log('üéØ Onclick handler:', checkoutBtn.onclick ? 'Definido' : 'No definido');
                    console.log('üõ†Ô∏è handleCheckoutClick:', typeof window.handleCheckoutClick);
                    console.log('üõ†Ô∏è window.enviarCarrito:', typeof window.enviarCarrito);
                    console.log('üõ†Ô∏è checkoutManager:', typeof checkoutManager);
                    
                    // Verificar estado para checkout
                    const userLoggedIn = localStorage.getItem('userLoggedIn') === 'true';
                    console.log('ÔøΩ Usuario logueado:', userLoggedIn);
                    console.log('üõí Items en carrito:', carrito.length);
                    
                    if (!userLoggedIn) {
                        console.log('‚ö†Ô∏è NOTA: Usuario no est√° logueado, se requerir√° login');
                    }
                    
                    if (carrito.length === 0) {
                        console.log('‚ö†Ô∏è NOTA: Carrito vac√≠o, se mostrar√° mensaje');
                    }
                    
                    console.log('‚úÖ Bot√≥n checkout configurado correctamente');
                } else {
                    console.error('‚ùå PROBLEMA: Bot√≥n checkout no encontrado');
                }
                
                console.log('=== FIN DIAGN√ìSTICO CHECKOUT ===');
            }, 1500);
        });
        
        // Funci√≥n para limpiar completamente el carrito (para uso manual)
        function limpiarCarritoCompleto() {
            localStorage.removeItem('carrito');
            console.log('üßπ Carrito completamente limpiado');
            location.reload();
        }
        
        // Funci√≥n para diagnosticar checkout manualmente
        function diagnosticarCheckout() {
            console.log('üîß === DIAGN√ìSTICO MANUAL CHECKOUT ===');
            console.log('Bot√≥n:', document.getElementById('confirmar-productos'));
            console.log('handleCheckoutClick:', typeof window.handleCheckoutClick);
            console.log('window.enviarCarrito:', typeof window.enviarCarrito);
            console.log('checkoutManager:', typeof checkoutManager);
            console.log('Usuario logueado:', localStorage.getItem('userLoggedIn'));
            console.log('Carrito:', JSON.parse(localStorage.getItem('carrito') || '[]'));
            
            // Intentar ejecutar checkout directamente
            if (typeof window.handleCheckoutClick === 'function') {
                console.log('üöÄ Ejecutando handleCheckoutClick...');
                window.handleCheckoutClick();
            } else {
                console.error('‚ùå handleCheckoutClick no disponible');
            }
        }
        
        // Funci√≥n para simular usuario logueado
        function simularLogin() {
            localStorage.setItem('userLoggedIn', 'true');
            localStorage.setItem('currentUser', JSON.stringify({
                email: 'test@ejemplo.com',
                nombre: 'Usuario',
                apellido: 'Test',
                cedula: '1234567890'
            }));
            console.log('‚úÖ Usuario test simulado');
            alert('Usuario test logueado correctamente');
        }
        
        // Funci√≥n para agregar producto de prueba
        function agregarProductoPrueba() {
            const carrito = JSON.parse(localStorage.getItem('carrito') || '[]');
            const productoPrueba = {
                id: 1,
                nombre: 'Producto de Prueba',
                precio: 50.00,
                imagen: './static/img/producto.png',
                cantidad: 1
            };
            
            carrito.push(productoPrueba);
            localStorage.setItem('carrito', JSON.stringify(carrito));
            console.log('‚úÖ Producto de prueba agregado');
            location.reload();
        }
        
        // Hacer funciones globales
        window.limpiarCarritoCompleto = limpiarCarritoCompleto;
        window.diagnosticarCheckout = diagnosticarCheckout;
        window.simularLogin = simularLogin;
        window.agregarProductoPrueba = agregarProductoPrueba;
    </script>

</body>
</html>
